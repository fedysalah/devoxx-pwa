<html>
    <head>
        <title>Devoxx - PWA Showcase</title>
        <meta http-equiv="Content-Type"content="text/html; charset=utf-8">
        <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
        <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
        <link rel="stylesheet" href="../../../assets/css/style.css"/>
        <style>
            #status {
                width: 100%;
                padding: 0.5em;
            }
            #exchange-rate{
                display: flex;
                flex-direction: column;
            }
            .new-exchange-container {
                display: flex;
                flex-direction: column;
            }
            .container {
                text-align: center;
            }
            .container img {
                width: 30%;
            }
            .new-exchange {
                background-color: yellow;
            }
            
        </style>
    </head>
    <body>
        <nav>
            <img src="../../../assets/images/devoxx_brand.gif" width="183" height="25" class="responsive-img logo-vis" alt="Devoxx Belgium">
            <h1><a href="../../../index.html">PWA Showcase</a></h1>
            <span class="twitter-account">@gsoldera / @fedysalah</span>
        </nav>
        <div class="content">
            <h2>Offline - Cache then network</h2>
            
            <div id="loader">

            </div>
            <div id="status">
                <button class="btn" onclick="refreshExchangeRate()">Exchange rate</button>
                <div id="new"></div>
                <div id="exchange-rate"></div>
            </div>
            
            <div class="container">
                <img src="../../../assets/images/cache-then-network.png">
            </div>
        </div>
        <script>
            var loaderContainer = document.getElementById('loader');
            var newContainer = document.getElementById('new');
            var statusContainer = document.getElementById('exchange-rate');
            var url = 'https://www.alphavantage.co/query?function=CURRENCY_EXCHANGE_RATE&from_currency=BTC&to_currency=EUR&apikey=AK9RPK8GOSQC5KP4'
            
            function startSpinner() {
                loaderContainer.innerHTML = '<span><i>Fetching...</i></span>'
            }

            function stopSpinner() {
                loaderContainer.innerHTML = ''
            }

            function showErrorMessage() {
                loaderContainer.innerHTML = '<span><b>Error during fetching</b></span>'
            }

            function updatePageWithNew() {

            }

            function updatePage(data) {
                var newValueContainer = document.createElement('div');
                if (!data) {
                    data = networkData;
                    newContainer.innerHTML = '';
                    newValueContainer.classList.add('new-exchange');
                }
                if (data["Realtime Currency Exchange Rate"]) {
                    var currencyExchangeRate = data["Realtime Currency Exchange Rate"];
                    var fromCurrency = currencyExchangeRate["2. From_Currency Name"]
                    var toCurrency = currencyExchangeRate["4. To_Currency Name"]
                    var exchangeRate = currencyExchangeRate["5. Exchange Rate"]
                    var lastRefreshed = currencyExchangeRate["6. Last Refreshed"]
                    newValueContainer.classList.add('new-exchange-container');
                    var fromCurrencyContainer = document.createElement('span');
                    fromCurrencyContainer.innerHTML = 'From currency : ' + fromCurrency;
                    var toCurrencyContainer = document.createElement('span');
                    toCurrencyContainer.innerHTML = 'To currency : ' + toCurrency;
                    var exchangeRateContainer = document.createElement('span');
                    exchangeRateContainer.innerHTML = 'Exchange rate : ' + exchangeRate;
                    var lastRefreshedContainer = document.createElement('span');
                    lastRefreshedContainer.innerHTML = 'Last refreshed : ' + lastRefreshed;
                    var separator = document.createElement('span');
                    separator.innerHTML = '------------------------------<br>'
                    newValueContainer.appendChild(fromCurrencyContainer);
                    newValueContainer.appendChild(toCurrencyContainer);
                    newValueContainer.appendChild(exchangeRateContainer);
                    newValueContainer.appendChild(lastRefreshedContainer);
                    newValueContainer.appendChild(separator);
                    statusContainer.innerHTML = '';
                    
                    statusContainer.appendChild(newValueContainer)
                    

                }
            }

            function showNew() {
                newContainer.innerHTML = '<button class="btn" onclick="updatePage()">Show new</button>'
            }

            function refreshExchangeRate() {
                var networkDataReceived = false;
                if (statusContainer.firstChild) {
                    statusContainer.firstChild.classList.remove('new-exchange');
                }
                startSpinner();
                
                
                console.log('fetch fresh data');
                var networkUpdate = fetch(url).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    networkDataReceived = true;
                    //updatePage(data);
                    showNew();
                    networkData = data;
                })

                console.log('fetch cached data');
                caches.match(url).then(function(response) {
                    if (!response) throw Error("No data");
                    return response.json();
                }).then(function(data) {
                // don't overwrite newer network data
                    if (!networkDataReceived) {
                        updatePage(data);
                    }
                }).catch(function() {
                // we didn't get cached data, the network is our last hope:
                    return networkUpdate;
                })
                .catch(showErrorMessage)
                .then(stopSpinner);
            }


            function initialLoad() {
                caches.match(url).then(function(response) {
                    return response.json();
                }).then(function(data) {
                    updatePage(data);
                }).catch(function() {
                
                })
            }


            function registerSW(swUrl) {
                navigator.serviceWorker
                .register(swUrl, {scope: './'})
                .then(registration => {
                    registration.onupdatefound = () => {
                    const installingWorker = registration.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed') {
                        if (navigator.serviceWorker.controller) {
                            // At this point, the old content will have been purged and
                            // the fresh content will have been added to the cache.
                            // It's the perfect time to display a "New content is
                            // available; please refresh." message in your web app.
                            //document.getElementById('status').innerHTML = 'New content is available; please refresh.'
                            console.log('New content is available; please refresh.');
                        } else {
                            // At this point, everything has been precached.
                            // It's the perfect time to display a
                            // "Content is cached for offline use." message.
                            //document.getElementById('status').innerHTML = 'Content is cached for offline use.'
                            console.log('Content is cached for offline use.');
                        }
                        }
                    };
                    };
                })
                .catch(error => {
                    console.error('Error during service worker registration:', error);
                });
            }
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    registerSW('./cache-then-network.js');
                    initialLoad();
                });
            } else {
                document.getElementById('status').innerHTML = 'Service worker not available'
            }
        </script>
    </body>
</html>